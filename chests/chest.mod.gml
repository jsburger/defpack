#define init
  global.sprRockletChest     = sprite_add_weapon("../sprites/chests/sprRockletChest.png", 8, 6);
  global.sprRockletChestOpen = sprite_add("../sprites/chests/sprRockletChestOpen.png", 1, 8, 6);

  global.sprVectorChest     = sprite_add_weapon("../sprites/chests/sprVectorChest.png", 9, 6);
  global.sprVectorChestOpen = sprite_add("../sprites/chests/sprVectorChestOpen.png", 1, 9, 6);

  global.sprZenithChest     = sprite_add_weapon("../sprites/chests/sprZenithChest.png", 8, 6);
  global.sprZenithChestOpen = sprite_add("../sprites/chests/sprZenithChestOpen.png", 1, 8, 6);

  global.sprQuartzChest     = sprite_add_weapon("../sprites/chests/sprQuartzChest.png", 8, 6);
  global.sprQuartzChestOpen = sprite_add("../sprites/chests/sprQuartzChestOpen.png", 1, 8, 6);

  global.sprRegalChest     = sprite_add_weapon("../sprites/chests/sprRegalChest.png", 8, 6);
  global.sprRegalChestOpen = sprite_add("../sprites/chests/sprRegalChestOpen.png", 1, 8, 6);

  global.sprUltraChest     = sprite_add_weapon("../sprites/chests/sprUltraChest.png", 8, 6);
  global.sprUltraChestOpen = sprite_add("../sprites/chests/sprUltraChestOpen.png", 1, 8, 6);

  global.sprToxicChest     = sprite_add_weapon("../sprites/chests/sprToxicChest.png", 8, 6);
  global.sprToxicChestOpen = sprite_add("../sprites/chests/sprToxicChestOpen.png", 1, 8, 6);

  global.sprComboChest     = sprite_add_weapon("../sprites/chests/sprComboChest.png", 8, 7);
  global.sprComboChestOpen = sprite_add("../sprites/chests/sprComboChestOpen.png", 1, 8, 7);

  global.sprSmartChest     = sprite_add_weapon("../sprites/chests/sprSmartChest.png", 8, 6);
  global.sprSmartChestOpen = sprite_add("../sprites/chests/sprSmartChestOpen.png", 1, 8, 6);

  global.sprFlameChest     = sprite_add_weapon("../sprites/chests/sprFlameChest.png", 8, 6);
  global.sprFlameChestOpen = sprite_add("../sprites/chests/sprFlameChestOpen.png", 1, 8, 6);

  global.sprBloodChest     = sprite_add_weapon("../sprites/chests/sprBloodChest.png", 8, 6);
  global.sprBloodChestOpen = sprite_add("../sprites/chests/sprBloodChestOpen.png", 1, 8, 6);

  global.sprHyperChest     = sprite_add_weapon("../sprites/chests/sprHyperChest.png", 8, 6);
  global.sprHyperChestOpen = sprite_add("../sprites/chests/sprHyperChestOpen.png", 1, 8, 6);

  global.sprAutoChest     = sprite_add_weapon("../sprites/chests/sprAutoChest.png", 8, 6);
  global.sprAutoChestOpen = sprite_add("../sprites/chests/sprAutoChestOpen.png", 1, 8, 6);

  global.sprToolChest     = sprite_add_weapon("../sprites/chests/sprToolChest.png", 10, 6);
  global.sprToolChestOpen = sprite_add("../sprites/chests/sprToolChestOpen.png", 1, 10, 6);

  global.sprAoEChest     = sprite_add_weapon("../sprites/chests/sprAoEChest.png", 9, 6);
  global.sprAoEChestOpen = sprite_add("../sprites/chests/sprAoEChestOpen.png", 1, 9, 6);

  global.sprHitscanChest     = sprite_add_weapon("../sprites/chests/sprHitscanChest.png", 10, 6);
  global.sprHitscanChestOpen = sprite_add("../sprites/chests/sprHitscanChestOpen.png", 1, 10, 6);


  global.sprMinecraftChest     =  sprite_add_weapon("../sprites/chests/sprMinecraftChest.png", 7, 7);
  global.sprMinecraftChestOpen =  sprite_add("../sprites/chests/sprMinecraftChestOpen.png", 1, 7, 7);

  global.sprRustyChest     =  sprite_add_weapon("../sprites/chests/sprRustyChest.png", 8, 6);
  global.sprRustyChestOpen =  sprite_add("../sprites/chests/sprRustyChestOpen.png", 1, 8, 6);

  global.sprTinyChest     =  sprite_add_weapon("../sprites/chests/sprTinyChest.png", 6, 3);
  global.sprTinyChestOpen =  sprite_add("../sprites/chests/sprTinyChestOpen.png", 1, 6, 3);

  global.sprLoopChest     =  sprite_add_weapon("../sprites/chests/sprLoopChest.png", 8, 6);
  global.sprLoopChestOpen =  sprite_add("../sprites/chests/sprLoopChestOpen.png", 1, 8, 6);

  global.sprNintendoChest     =  sprite_add_weapon("../sprites/chests/sprNintendoChest.png", 8, 6);
  global.sprNintendoChestOpen =  sprite_add("../sprites/chests/sprNintendoChestOpen.png", 1, 8, 6);

  global.sprIDPDChest     =  sprite_add_weapon("../sprites/chests/sprIDPDChest.png", 8, 6);
  global.sprIDPDChestOpen =  sprite_add("../sprites/chests/sprIDPDChestOpen.png", 1, 8, 6);

  global.sprEplasmaChest     =  sprite_add_weapon("../sprites/chests/sprEplasmaChest.png", 8, 6);
  global.sprEplasmaChestOpen =  sprite_add("../sprites/chests/sprEplasmaChestOpen.png", 1, 8, 6);

  global.sprBubbleChest     =  sprite_add_weapon("../sprites/chests/sprBubbleChest.png", 9, 6);
  global.sprBubbleChestOpen =  sprite_add("../sprites/chests/sprBubbleChestOpen.png", 1, 9, 6);

  global.sprQuasarChest     =  sprite_add_weapon("../sprites/chests/sprQuasarChest.png", 8, 6);
  global.sprQuasarChestOpen =  sprite_add("../sprites/chests/sprQuasarChestOpen.png", 1, 8, 6);

  global.sprSawbladeChest     =  sprite_add_weapon("../sprites/chests/sprSawbladeChest.png", 8, 6);
  global.sprSawbladeChestOpen =  sprite_add("../sprites/chests/sprSawbladeChestOpen.png", 1, 8, 6);

  global.sprDownwellChest     =  sprite_add_weapon("../sprites/chests/sprDownwellChest.png", 8, 6);
  global.sprDownwellChestOpen =  sprite_add("../sprites/chests/sprDownwellChestOpen.png", 1, 8, 6);

  global.sprDeltaChest     =  sprite_add_weapon("../sprites/chests/sprDeltaChest.png", 8, 6);
  global.sprDeltaChestOpen =  sprite_add("../sprites/chests/sprDeltaChestOpen.png", 1, 8, 6);

  global.sprCloudChest     =  sprite_add_weapon("../sprites/chests/sprCloudChest.png", 8, 6);
  global.sprCloudChestOpen =  sprite_add("../sprites/chests/sprCloudChestOpen.png", 1, 8, 6);

  global.sprThunderCloudChest     =  sprite_add_weapon("../sprites/chests/sprThunderCloudChest.png", 8, 6);
  global.sprThunderCloudChestOpen =  sprite_add("../sprites/chests/sprThunderCloudChestOpen.png", 1, 8, 6);

  global.sprChargeChest     =  sprite_add_weapon("../sprites/chests/sprChargeChest.png", 8, 6);
  global.sprChargeChestOpen =  sprite_add("../sprites/chests/sprChargeChestOpen.png", 1, 8, 6);

  global.sprStarlightChest     =  sprite_add_weapon("../sprites/chests/sprStarlightChest.png", 8, 6);
  global.sprStarlightChestOpen =  sprite_add("../sprites/chests/sprStarlightChestOpen.png", 1, 8, 6);

  global.sprGhostChest     =  sprite_add_weapon("../sprites/chests/sprGhostChest.png", 9, 6);
  global.sprGhostChestOpen =  sprite_add("../sprites/chests/sprGhostChestOpen.png", 1, 9, 6);


  global.sprMeleeChest     = sprite_add_weapon("../sprites/chests/sprWepMutChestMelee.png"    , 11, 8);
  global.sprBulletChest    = sprite_add_weapon("../sprites/chests/sprWepMutChestBullet.png"   , 11, 8);
  global.sprShellChest     = sprite_add_weapon("../sprites/chests/sprWepMutChestShell.png"    , 11, 8);
  global.sprBoltChest      = sprite_add_weapon("../sprites/chests/sprWepMutChestBolt.png"     , 11, 8);
  global.sprEnergyChest    = sprite_add_weapon("../sprites/chests/sprWepMutChestEnergy.png"   , 11, 8);
  global.sprExplosiveChest = sprite_add_weapon("../sprites/chests/sprWepMutChestExplosive.png", 11, 8);

  global.sprMeleeChestC     = sprite_add_weapon("../sprites/chests/sprWepMutChestMeleeCursed.png"    , 11, 8);
  global.sprBulletChestC    = sprite_add_weapon("../sprites/chests/sprWepMutChestBulletCursed.png"   , 11, 8);
  global.sprShellChestC     = sprite_add_weapon("../sprites/chests/sprWepMutChestShellCursed.png"    , 11, 8);
  global.sprBoltChestC      = sprite_add_weapon("../sprites/chests/sprWepMutChestBoltCursed.png"     , 11, 8);
  global.sprEnergyChestC    = sprite_add_weapon("../sprites/chests/sprWepMutChestEnergyCursed.png"   , 11, 8);
  global.sprExplosiveChestC = sprite_add_weapon("../sprites/chests/sprWepMutChestExplosiveCursed.png", 11, 8);

  global.sprMeleeChestOpen     = sprite_add("../sprites/chests/sprWepMutChestOpen.png", 1, 11, 8);
  global.sprMeleeChestOpenC    = sprite_add("../sprites/chests/sprWepMutChestOpenCursed.png", 1, 11, 8);

  global.sprBulletChestOpen    = global.sprMeleeChestOpen;
  global.sprShellChestOpen     = global.sprMeleeChestOpen;
  global.sprBoltChestOpen      = global.sprMeleeChestOpen;
  global.sprExplosiveChestOpen = global.sprMeleeChestOpen;
  global.sprEnergyChestOpen    = global.sprMeleeChestOpen;

  global.sprBulletChestOpenC    = global.sprMeleeChestOpenC;
  global.sprShellChestOpenC     = global.sprMeleeChestOpenC;
  global.sprBoltChestOpenC      = global.sprMeleeChestOpenC;
  global.sprExplosiveChestOpenC = global.sprMeleeChestOpenC;
  global.sprEnergyChestOpenC    = global.sprMeleeChestOpenC;

  global.chest_ban_list = ["SUPER DISC GUN", "GOLDEN DISC GUN", "GOLDEN NUKE LAUNCHER", "WONDERSWORD", "FLAK CANON", "SPAM DISC GUN"];

  global.chests = ds_map_create()
  chest_add("Ultra",   14, [wep_ultra_revolver,wep_ultra_shovel,wep_ultra_shotgun,wep_ultra_laser_pistol,wep_ultra_crossbow,wep_ultra_grenade_launcher,"ultra hand","defender","ultra gunhammer"])
  chest_add("AoE",     6,  ["blaster","buster","puncher"])
  chest_add("Hitscan", 7,  ["subata","moby","big iron"])
  chest_add("Rocklet", 9,  ["rocklet pistol","rocklet rifle","rocklet cannon","super rocklet cannon","rocklet minigun"])
  chest_add("Toxic",   3,  ["toxicthrower","cobra","toxic carronader",wep_toxic_bow,wep_toxic_launcher,"gas lighter"])
  chest_add("Tool",    3,  [wep_wrench,wep_screwdriver,wep_jackhammer,"chainsaw","nail gun","rivet gun"])
  chest_add("Combo",   6,  ["rapier","rebounce axe","spin hammer"])
  chest_add("Vector",  6,  ["vector rifle","vector shotgun","vector cannon"])
  chest_add("Regal",   5,  ["arc classique","duelist","kemosabe"])
  chest_add("Smart",   7,  [wep_smart_gun,"heavy smart gun", "smarter gun", "smart nuke launcher", "smart abris rifle"])
  chest_add("Auto",    6,  [wep_auto_shotgun,wep_auto_crossbow,wep_auto_grenade_shotgun,wep_heavy_auto_crossbow,"auto abris launcher","auto screwdriver","auto knife thrower"])
  chest_add("Quartz",  10, ["quartz machinegun","quartz shotgun","quartz crossbow","quartz laser","quartz launcher","quartz sword"])
  chest_add("Flame",   8,  [wep_flare_gun,wep_dragon,wep_flamethrower,wep_flame_cannon,"firestorm"])
  chest_add("Blood",   9,  [wep_blood_hammer,"bone","big bone",wep_blood_launcher,wep_blood_cannon,"blood abris launcher","blood crossbow","punisher"])
  chest_add("Hyper",   9,  [wep_hyper_rifle,wep_hyper_slugger,wep_hyper_launcher,"hyper crossbow","hyper bow"])
  chest_add("Zenith",  13, ["herald","andromeda launcher","stopwatch",/*"sak",*/"defender","flex","punisher","rapier","record dealer"])

  chest_add("Melee",     -1, 0).wep_script = script_ref_create(typed_chest_get_weps, 0)
  chest_add("Bullet",    -1, 1).wep_script = script_ref_create(typed_chest_get_weps, 1)
  chest_add("Shell",     -1, 2).wep_script = script_ref_create(typed_chest_get_weps, 2)
  chest_add("Bolt",      -1, 3).wep_script = script_ref_create(typed_chest_get_weps, 3)
  chest_add("Explosive", -1, 4).wep_script = script_ref_create(typed_chest_get_weps, 4)
  chest_add("Energy",    -1, 5).wep_script = script_ref_create(typed_chest_get_weps, 5)
  
    global.meleeSkills  = [mut_long_arms, "longarmsx10", "dividedelbows", "vote1", "screwdriver mastery"]
    global.bulletSkills = [mut_recycle_gland, "recycleglandx10", "prismaticiris", "excitedneurons", "vote2", "Rocket Casings"]
    global.shellSkills  = [mut_shotgun_shoulders, "shotgunshouldersx10", "powderedgums", "vote3", "Shattered Skull", "Shocked Skin", "shells to shots"]
    global.boltSkills   = [mut_bolt_marrow, "boltmarrowx10", "vote4", "Staked Chest", "Energized Intestines"]
    global.exploSkills  = [mut_boiling_veins, "boilingveinsx10", "pyromania", "vote5", "Waste Gland", "Toxic Thoughts", "Fractured Fingers", "Pressurized Lungs", "flamingpalms"]
    global.energySkills = [mut_laser_brain, "laserbrainx10", "concentration", "vote6", "Neural Network", "Deep Convolutional Network", "Deep Residual Network",
                            "Echo State Network", "Feed Forward Network", "Generative Adversarial Network", "Markov Chain", "Recurrent Neural Network",
                            "Support Vector Machines", "conductivity"]

    global.typeArray = ["Melee", "Bullet", "Shell", "Bolt", "Explosive", "Energy"]
  

#define game_start
    
      // weapon mods innate support because the original creators aint going to touch their own stuff again
  if mod_exists("weapon", "NetheriteSword"){ //minecraft weapons
    chest_add("Minecraft", 3, ["WoodenSword", "WoodenShovel", "WoodenPickaxe", "WoodenHod", "WoodenAxe", "Bow", "Crossbow", "StoneSword", "StoneShovel", "StonePickaxe", "StoneHod", "StoneAxe", "IronSword", "IronShovel", "IronPickaxe", "IronHod", "IronAxe", "GoldenSword", "GoldenPickaxe", "GoldenHod", "GoldenAxe", "DiamondSword", "DiamondShovel", "DiamondPickaxe", "DiamondHod", "DiamondAxe", "NetheriteSword", "NetheriteShovel", "NetheritePickaxe", "NetheriteHod", "NetheriteAxe"])
  }
  if mod_exists("mod", "yokinLightning"){ //goodmod
    chest_add("Rusty", 3, [wep_rusty_revolver, "rusty crossbow", "rusty grenade launcher", "rusty laser pistol", "rusty shotgun", "old engine"])
  }
  if mod_exists("weapon", "tiny crossbow"){ //tinyweps
    chest_add("Tiny", 1, ["tiny crossbow", "tiny grenade launcher", "tiny laser pistol", "tiny machinegun", "tiny shotgun", "tiny wrench"])
  }
  if mod_exists("weapon", "loopgatlingslugger"){ //loopwep
    chest_add("Loop", 16, ["loopgatlingslugger", "loopplasmaminigun", "looplaserminigun", "loopgatlingbazooka", "loopminigun", "loopheavyautocrossbow", "loopautocrossbow"])
  }
  if mod_exists("weapon", "pow block"){ //nintendo weps
    chest_add("Nintendo", 6, ["arm cannon", "master sword", "mega buster", "pow block"])
  }
  if mod_exists("weapon", "idpdfreakgrenadelauncher"){ //idpd weps
    chest_add("IDPD", 10, ["idpdgun", "idpdrifle", "idpdgrenadelauncher", "idpdheavygun", "idpdslugger", "idpdheavyslugger", "idpdelitegun", "idpdrocketlauncher", "idpdplasmaminigun", "idpdenergybaton", "idpdfreakgun", "idpdfreakgrenadelauncher"])
  }
  if mod_exists("mod", "ntte"){//sawblade, quasar, bubble, eplasma
    chest_add("Bubble"  ,  5, ["bubble rifle", "bubble shotgun", "bubble minigun", "bubble cannon", "bubble bat", "hyper bubbler"])
    chest_add("Eplasma" ,  8, ["electroplasma rifle", "electroplasma shotgun", "electroplasma cannon"])
    chest_add("Sawblade",  7, ["bat disc launcher", "bat disc cannon", "pizza cutter"])
    chest_add("Quasar"  , 12, ["quasar blaster", "quasar rifle", "quasar cannon"])
  }
  if mod_exists("weapon", "gemhighmachinegunmodule"){ //downwell weps
    chest_add("Downwell", 4, ["gemhighmachinegunmodule", "burstmodule", "gemhighburstmodule", "lasermodule", "gemhighlasermodule", "laserriflemodule", "gemhighlaserriflemodule", "noppymodule", "gemhighnoppymodule", "punchermodule", "gemhighpunchermodule", "shotgunmodule", "gemhighshotgunmodule", "triplemodule", "gemhightriplemodule"])
  }
  if mod_exists("weapon", "delta rifle"){ //delta weps
    chest_add("Delta", 15, ["delta rifle", "delta slugger", "delta splinter gun", "delta bazooka", "delta plasma gun", "delta saber"])
  }
  if mod_exists("weapon", "accuserhand"){ //charge weps
    chest_add("Charge", 7, ["chargegun", "chargeslugger", "chargeflak", "chargecrossbow", "chargedisc", "chargebazooka", "chargeflamethrower", "chargelaser", "chargeplasma", "chargeblade"])
  }
  if mod_exists("weapon", "cannondemnation"){ //xefsweps: cloud, thundercloud
    chest_add("Cloud"       , 4, ["cloud pistol", "cloud rifle", "cloud shotgun", "cloud cannon", "cloud minigun"])
    chest_add("ThunderCloud", 8, ["thunder cloud pistol", "thunder cloud rifle", "thunder cloud shotgun", "thunder cloud cannon", "thunder cloud minigun"])
  }
  if mod_exists("weapon", "StarlightSpiritWave"){ //Gunbucket: Starlight, Ghost
      chest_add("Starlight", 11, ["StarlightSpiritGun", "StarlightSpiritRifle", "StarlightSpiritWave", "StarlightSpiritCannon"]);
      chest_add("Ghost"    ,  5, ["GhostMachinegun", "GhostSlugger", "GhostSluggerAssault", "GhostSluggerGatling"]);
  }

#define step
     // replacing chests
    if !instance_exists(GenCont){
        with instances_matching(instances_matching(WeaponChest, "object_index", WeaponChest), "defcustomchestcheck", null){
            defcustomchestcheck = 1
            var _chance = min((GameCont.wepmuts > 0 ? 10 : 0) + GameCont.wepmuts * 10 + (crown_current = crwn_guns) * 33 + (crown_current = "exchange") * 33, 80);

            if skill_get(mut_heavy_heart) > 0 && _chance > 0 _chance = 100 * skill_get(mut_heavy_heart)
            
            if (random(100) <= _chance) {
                
                var typeList = [];
                for (var i = 0; i <= 100; i++) {
                    var skill = skill_get_at(i);
                    if skill == undefined {
                        break
                    }
                    var typeTest = skill_get_chest_type(skill);
                    if typeTest != undefined {
                        if global.chests[? typeTest] == undefined
                            trace_color(`Skill mod '${skill}' returned a chest type that doesn't exist`, c_red)
                        else array_push(typeList, typeTest)
                    }
                }
                
                if (crown_current = crwn_guns || crown_current = "exchange") {
                    array_push(typeList, "Melee")
                    array_push(typeList, "Bullet")
                    array_push(typeList, "Shell")
                    array_push(typeList, "Bolt")
                    array_push(typeList, "Explosive")
                    array_push(typeList, "Energy")
                }

                
                if array_length(typeList) > 0 {
                    with customchest_create(x, y, typeList[irandom(array_length(typeList) - 1)]) {
                        curse = other.curse
                        
                        if curse switch subname {
                            case "Bullet":
                                sprite_index = global.sprBulletChestC;
                                spr_open = global.sprBulletChestOpenC;
                                break;
                            case "Shell":
                                sprite_index = global.sprShellChestC;
                                spr_open = global.sprShellChestOpenC;
                                break;
                            case "Bolt":
                                sprite_index = global.sprBoltChestC;
                                spr_open = global.sprBoltChestOpenC;
                                break;
                            case "Explosive":
                                sprite_index = global.sprExplosiveChestC;
                                spr_open = global.sprExplosiveChestOpenC;
                                break;
                            case "Energy":
                                sprite_index = global.sprEnergyChestC;
                                spr_open = global.sprEnergyChestOpenC;
                                break;
                            case "Melee":
                                sprite_index = global.sprMeleeChestC;
                                spr_open = global.sprMeleeChestOpenC;
                                break;
                        }
                    }
                    
                    instance_delete(self)
                }
            }
            
            else if random(100) <= 10 and !instance_is(self, BigWeaponChest) and !instance_is(self, BigCursedChest) and !instance_is(self, GiantWeaponChest) && (skill_get(mut_open_mind) > 0 || skill_get("thinktank") > 0) {
                var q = get_chests(0, GameCont.hard)
                if array_length(q){
                    with customchest_create(x, y, q[irandom(array_length(q) - 1)]) {

                      defpack_no_reroll = true;
                    }
                    instance_delete(self)
                }
            }
        }
    }

     // chest step
    with instances_matching(chestprop, "name", "DefCustomChest"){
        if curse = true{
            if irandom(1) instance_create(x + random_range(-6, 6), y - 4 + random_range(-1, 1), Curse)
        }
        if place_meeting(x, y, Player) sound_play(instance_nearest(x, y, Player).snd_chst)
        if place_meeting(x, y, Player) || place_meeting(x, y, PortalShock) || instance_exists(BigPortal){
             // run open code
            script_execute(on_open)

            for(var _i = 0; _i < 4; _i++){
              with Wall{
                if distance_to_object(other) <= 16{
                  instance_create(x, y, FloorExplo);
                  instance_destroy()
                }
              }
            }

             // fx
            instance_create(x, y, FXChestOpen);
            with instance_create(x, y, ChestOpen)
                sprite_index = other.spr_open;
            if curse = true sound_play(sndCursedChest)

            instance_delete(id);
        }
    }
  if button_pressed(0, "horn") == true and string_lower(player_get_alias(0)) == "karmelyth*"{
      /*with ds_map_keys(global.chests){
          customchest_create(mouse_x[0], mouse_y[0], self)
      }*/
      customchest_create(mouse_x[0], mouse_y[0], global.chests[? "Hyper"])
  }

#define chest_add(Name, Hard, Weapons)
  global.chests[? Name] = {
      name : Name,
      spr_idle : mod_variable_get("mod", mod_current, "spr"+Name+"Chest"),
      spr_open : mod_variable_get("mod", mod_current, "spr"+Name+"ChestOpen"),
      weps : Weapons,
      difficulty : Hard,
      wep_script : script_ref_create(custom_chest_get_weps)
  }
  return global.chests[? Name]

#define get_chests(areamin, areamax)
  var q = ds_map_values(global.chests), a = [];
  with q{
      if difficulty >= areamin and difficulty <= areamax array_push(a, name)
  }
  return a

#define customchest_create(xx, yy, Type)
      var o = instance_create(xx, yy, chestprop);
      with(o){
          curse = false
          name = "DefCustomChest";
          defpack_no_reroll = false;
          type = Type// specifc chest type
          var q = global.chests[? Type]
          spr_open = q.spr_open
          sprite_index = q.spr_idle
          weps = q.weps
          scrGetWeps = q.wep_script
          subname = q.name
          on_open = customchest_open;
      }
      return o;

#define customchest_open
    sound_play(sndAmmoChest);

    var wepList = filter_weps_by_existing(script_ref_call(scrGetWeps, self)),
        length = array_length(wepList),
        finalWeps = [];
        
    switch (length) {
        case 0:
            finalWeps = [wep_screwdriver];
            break
        case 1:
        case 2:
            finalWeps = wepList
            break
        default:
            var first = irandom(length - 1),
                second = first;
            while (second == first) {
                second = irandom(length - 1)
            }
            finalWeps = [wepList[first], wepList[second]]
            break
    }

    for (var i = array_length(finalWeps) - 1; i >= 0; i--) {
        with instance_create(x, y, WepPickup) {
            curse = other.curse;
            wep = finalWeps[i];
            roll = 1;
            if (weapon_get_type(wep) != 0) ammo = 1
            //What does this variable do?
            defpack_no_reroll = other.defpack_no_reroll;
        }
    }
    
#define custom_chest_get_weps(chest)
//Default script used by weapon chests
    return filter_weps_by_difficulty(chest.weps, 0, GameCont.hard + 2, chest.curse);
    
#define weapon_get(w)
    return is_object(w) ? w.wep : w;

#define filter_weps_by_existing(wepArray)
//Filters out weapons that don't exist, returns an array
    var results = [];
    for (var i = array_length(wepArray) - 1; i >= 0; i--) {
        if is_real(weapon_get(wepArray[i])) || mod_exists("weapon", weapon_get(wepArray[i])) {
            array_push(results, wepArray[i])
        }
    }
    return results;

#define filter_weps_by_difficulty(wepArray, minimumHard, maxHard, cursed)
    var results = [],
        area;
    maxHard += get_difficulty_bonus(cursed)
    
    for (var i = array_length(wepArray) - 1; i >= 0; i--) {
        area = weapon_get_area(wepArray[i]);
        if (area >= minimumHard && area <= maxHard) {
            array_push(results, wepArray[i])
        }
    }
    return results;

#define get_difficulty_bonus(cursed)
    return (2 * cursed) + (player_count_race("robot"));

//Chest is always last argument as it is provided by the script_ref_call
#define typed_chest_get_weps(type, chest)
//Script used by typed weapon chests
    var weplist = ds_list_create();
    weapon_get_list(weplist, clamp(GameCont.hard - 1, 0, 6), GameCont.hard + get_difficulty_bonus(chest.curse) + 1)
    
    var returnedWeps = [];
    
    for (var i = ds_list_size(weplist) - 1; i >= 0; i--) {
        if weapon_get_type(weplist[| i]) == type && (array_find_index(global.chest_ban_list, weplist[| i]) == -1) {
            array_push(returnedWeps, weplist[| i])
        }
    }
    
    ds_list_destroy(weplist)
    return returnedWeps;
    
#define skill_get_chest_type(skill)
    if !is_real(skill) {
        var typeTest = mod_script_call("skill", skill, "skill_chest_type");
        if typeTest != undefined {
            if (is_real(typeTest) && typeTest >= 0 && typeTest <= 5)
                return index_get_ammo_type(typeTest)
            return typeTest
        }
    }
    
    if array_find_index(global.meleeSkills,  skill) != -1 return "Melee"
    if array_find_index(global.bulletSkills, skill) != -1 return "Bullet"
    if array_find_index(global.shellSkills,  skill) != -1 return "Shell"
    if array_find_index(global.boltSkills,   skill) != -1 return "Bolt"
    if array_find_index(global.exploSkills,  skill) != -1 return "Explosive"
    if array_find_index(global.energySkills, skill) != -1 return "Energy"
    
    return undefined
    
#define index_get_ammo_type(index)
    return global.typeArray[index]
